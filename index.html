<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bud Love Tickets</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#07070f;
      --panel:#111325;
      --line:#2a2f55;
      --txt:#eef1ff;
      --muted:#a6add6;
      --pink:#ff49b7;
      --purple:#865dff;
      --cyan:#43e6ff;
      --todo:#6fa8ff;
      --doing:#ffbf5f;
      --done:#67e7a7;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:"Space Grotesk",system-ui,sans-serif;
      color:var(--txt);
      background:
        radial-gradient(1000px 500px at 15% -10%, #4730ab55, transparent 60%),
        radial-gradient(900px 500px at 90% 0%, #ff49b733, transparent 60%),
        var(--bg);
      min-height:100vh;
    }
    .shell{max-width:1200px;margin:0 auto;padding:22px 16px 34px}
    .topbar{
      display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap;
      margin-bottom:14px;
    }
    .title-wrap{display:flex;flex-direction:column;gap:4px}
    h1{margin:0;font-size:clamp(1.35rem,3vw,2rem);letter-spacing:.02em;font-weight:800;filter:url(#rgbSplit)}
    .subtitle{color:var(--muted);font-size:.95rem}
    .controls{display:flex;gap:8px;flex-wrap:wrap}
    button{
      border:1px solid #ffffff22;background:#1a1d36;color:var(--txt);
      padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer;
    }
    .btn-primary{background:linear-gradient(90deg,var(--purple),var(--pink));border:none}
    .btn-ghost{background:#171a30}
    .board{display:grid;grid-template-columns:repeat(3,minmax(220px,1fr));gap:12px}
    .col{
      background:linear-gradient(180deg,#14182e,#0e1022);
      border:1px solid var(--line);border-radius:16px;padding:12px;min-height:420px;
      box-shadow:0 14px 30px #0008;
    }
    .col h2{margin:2px 0 10px;font-size:1rem;display:flex;justify-content:space-between;align-items:center}
    .dot{width:9px;height:9px;border-radius:50%}
    .todo .dot{background:var(--todo)}
    .doing .dot{background:var(--doing)}
    .done .dot{background:var(--done)}
    .list{display:flex;flex-direction:column;gap:10px;min-height:300px}
    .ticket{
      border:1px solid #ffffff1f;background:#1a1e3b;border-radius:12px;padding:10px;
      box-shadow:0 8px 20px #0006;position:relative;transition:.18s transform, .18s border-color;
    }
    .ticket:hover{transform:translateY(-2px);border-color:#ffffff4a;filter:url(#cardWarp)}
    .ticket.dragging{opacity:.5}
    .t-title{font-weight:700;margin:0 0 4px;line-height:1.28}
    .t-desc{margin:0 0 8px;color:var(--muted);font-size:.9rem;line-height:1.35;white-space:pre-wrap}
    .meta{display:flex;justify-content:space-between;gap:8px;font-size:.78rem;color:#c9d0ffb8}
    .actions{display:flex;justify-content:space-between;gap:6px;margin-top:8px}
    .chip{padding:4px 8px;border-radius:999px;font-size:.73rem;font-weight:700;border:1px solid #ffffff24}
    .p-high{color:#ff9aa9}.p-medium{color:#ffd68f}.p-low{color:#a8ffcc}
    .icon-btn{padding:6px 9px;border-radius:9px;background:#20244a;border:1px solid #ffffff21}
    .drop{border:1px dashed #8f95d7;background:#8388ff14}

    dialog{
      border:none;border-radius:16px;padding:0;max-width:540px;width:min(92vw,540px);
      background:#111429;color:var(--txt);box-shadow:0 30px 70px #000a;
    }
    .modal{padding:14px;display:grid;gap:10px}
    .modal h3{margin:2px 0}
    .field{display:grid;gap:6px}
    input,textarea,select{
      width:100%;background:#1b2040;border:1px solid #ffffff26;color:var(--txt);
      padding:10px;border-radius:10px;font:inherit;
    }
    textarea{min-height:92px;resize:vertical}
    .row{display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap}
    .status{font-size:.85rem;color:var(--muted)}

    @media (max-width: 900px){ .board{grid-template-columns:1fr} }
    @media (prefers-reduced-motion: reduce){ *{transition:none!important;animation:none!important} .ticket:hover{filter:none} h1{filter:none} }
  </style>
</head>
<body>
  <svg width="0" height="0" style="position:absolute">
    <filter id="rgbSplit" x="-20%" y="-20%" width="140%" height="140%">
      <feOffset in="SourceGraphic" dx="1.2" dy="0" result="rOff"/>
      <feColorMatrix in="rOff" type="matrix" values="1 0 0 0 0  0 0 0 0 0  0 0 0 0 0  0 0 0 1 0" result="r"/>
      <feOffset in="SourceGraphic" dx="-1.2" dy="0" result="bOff"/>
      <feColorMatrix in="bOff" type="matrix" values="0 0 0 0 0  0 0 0 0 0  0 0 1 0 0  0 0 0 1 0" result="b"/>
      <feBlend in="SourceGraphic" in2="r" mode="screen" result="rb"/>
      <feBlend in="rb" in2="b" mode="screen"/>
    </filter>

    <filter id="cardWarp" x="-20%" y="-20%" width="140%" height="140%">
      <feTurbulence type="fractalNoise" baseFrequency="0.9" numOctaves="1" seed="2" result="noise"/>
      <feDisplacementMap in="SourceGraphic" in2="noise" scale="2" xChannelSelector="R" yChannelSelector="G"/>
    </filter>
  </svg>

  <main class="shell">
    <section class="topbar">
      <div class="title-wrap">
        <h1>Bud Love Tickets</h1>
        <div class="subtitle">Track what matters. Do the tickets. Ship fast.</div>
      </div>
      <div class="controls">
        <button class="btn-primary" id="newBtn">+ New Ticket</button>
        <button class="btn-ghost" id="refreshBtn">↻ Refresh</button>
      </div>
    </section>

    <p class="status" id="status">Loading tickets...</p>

    <section class="board">
      <article class="col todo" data-status="todo"><h2><span>To Do</span><span class="dot"></span></h2><div class="list" id="todo"></div></article>
      <article class="col doing" data-status="doing"><h2><span>Doing</span><span class="dot"></span></h2><div class="list" id="doing"></div></article>
      <article class="col done" data-status="done"><h2><span>Done</span><span class="dot"></span></h2><div class="list" id="done"></div></article>
    </section>
  </main>

  <dialog id="modal">
    <form class="modal" id="form" method="dialog">
      <h3 id="modalTitle">New Ticket</h3>
      <input type="hidden" id="ticketId" />
      <div class="field"><label>Title</label><input id="title" required maxlength="180" /></div>
      <div class="field"><label>Description</label><textarea id="desc" placeholder="Optional"></textarea></div>
      <div class="field"><label>Priority</label>
        <select id="priority"><option value="low">low</option><option value="medium" selected>medium</option><option value="high">high</option></select>
      </div>
      <div class="field"><label>Status</label>
        <select id="statusSel"><option value="todo">todo</option><option value="doing">doing</option><option value="done">done</option></select>
      </div>
      <div class="row">
        <button type="button" id="deleteBtn" class="btn-ghost" style="margin-right:auto;display:none">Delete</button>
        <button type="button" id="cancelBtn" class="btn-ghost">Cancel</button>
        <button type="submit" class="btn-primary">Save</button>
      </div>
    </form>
  </dialog>

  <script>
    const API = '/api/tickets';
    const columns = ['todo','doing','done'];
    const state = { tickets: [] };

    const $ = (id)=>document.getElementById(id);
    const fmt = (d)=>new Date(d).toLocaleDateString();

    function setStatus(msg){ $('status').textContent = msg; }

    async function loadTickets(){
      try {
        const res = await fetch(API, { cache: 'no-store' });
        if (!res.ok) throw new Error('API unavailable');
        const json = await res.json();
        state.tickets = normalize(json.tickets || json || []);
        localStorage.setItem('budTicketsBackup', JSON.stringify(state.tickets));
        setStatus(`Loaded ${state.tickets.length} tickets`);
      } catch (e) {
        const cached = localStorage.getItem('budTicketsBackup');
        state.tickets = cached ? JSON.parse(cached) : [];
        setStatus('Offline mode: using local backup');
      }
      render();
    }

    function normalize(arr){
      return arr.map(t => ({
        id: String(t.id ?? Date.now() + Math.random()),
        title: t.title || 'Untitled',
        desc: t.desc || '',
        status: columns.includes(t.status) ? t.status : 'todo',
        priority: ['low','medium','high'].includes((t.priority||'').toLowerCase()) ? t.priority.toLowerCase() : 'medium',
        created: t.created || new Date().toISOString().slice(0,10)
      }));
    }

    async function saveTickets(){
      localStorage.setItem('budTicketsBackup', JSON.stringify(state.tickets));
      try {
        const res = await fetch(API, {
          method:'PUT', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ tickets: state.tickets })
        });
        if (!res.ok) throw new Error('save failed');
        setStatus(`Saved ${state.tickets.length} tickets`);
      } catch {
        setStatus('Saved locally (API unreachable)');
      }
      render();
    }

    function card(t){
      const el = document.createElement('article');
      el.className = 'ticket';
      el.draggable = true;
      el.dataset.id = t.id;
      el.innerHTML = `
        <p class="t-title">${escapeHtml(t.title)}</p>
        <p class="t-desc">${escapeHtml(t.desc)}</p>
        <div class="meta">
          <span class="chip p-${t.priority}">${t.priority}</span>
          <span>${fmt(t.created)}</span>
        </div>
        <div class="actions">
          <button class="icon-btn" data-act="left" title="Move left">◀</button>
          <button class="icon-btn" data-act="edit" title="Edit">✎</button>
          <button class="icon-btn" data-act="right" title="Move right">▶</button>
        </div>`;

      el.querySelector('[data-act="edit"]').onclick = () => openModal(t);
      el.querySelector('[data-act="left"]').onclick = () => shift(t.id, -1);
      el.querySelector('[data-act="right"]').onclick = () => shift(t.id, +1);

      el.addEventListener('dragstart', ()=>el.classList.add('dragging'));
      el.addEventListener('dragend', ()=>el.classList.remove('dragging'));
      return el;
    }

    function render(){
      columns.forEach(c => $(c).innerHTML = '');
      for(const t of state.tickets){ $(t.status).appendChild(card(t)); }
    }

    function shift(id, dir){
      const t = state.tickets.find(x=>x.id===id); if(!t) return;
      const i = columns.indexOf(t.status);
      t.status = columns[Math.max(0, Math.min(columns.length-1, i+dir))];
      saveTickets();
    }

    function openModal(t=null){
      $('modalTitle').textContent = t ? 'Edit Ticket' : 'New Ticket';
      $('ticketId').value = t?.id || '';
      $('title').value = t?.title || '';
      $('desc').value = t?.desc || '';
      $('priority').value = t?.priority || 'medium';
      $('statusSel').value = t?.status || 'todo';
      $('deleteBtn').style.display = t ? 'inline-block' : 'none';
      $('modal').showModal();
    }

    $('form').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const id = $('ticketId').value;
      const payload = {
        id: id || String(Date.now()),
        title: $('title').value.trim(),
        desc: $('desc').value.trim(),
        priority: $('priority').value,
        status: $('statusSel').value,
        created: id ? (state.tickets.find(t=>t.id===id)?.created || new Date().toISOString().slice(0,10)) : new Date().toISOString().slice(0,10)
      };
      if (!payload.title) return;
      if (id) {
        const i = state.tickets.findIndex(t=>t.id===id);
        if (i > -1) state.tickets[i] = payload;
      } else state.tickets.unshift(payload);
      $('modal').close();
      await saveTickets();
    });

    $('deleteBtn').onclick = async ()=>{
      const id = $('ticketId').value;
      state.tickets = state.tickets.filter(t=>t.id!==id);
      $('modal').close();
      await saveTickets();
    };
    $('cancelBtn').onclick = ()=> $('modal').close();
    $('newBtn').onclick = ()=> openModal();
    $('refreshBtn').onclick = ()=> loadTickets();

    document.querySelectorAll('.col').forEach(col => {
      const list = col.querySelector('.list');
      col.addEventListener('dragover', (e)=>{ e.preventDefault(); list.classList.add('drop'); });
      col.addEventListener('dragleave', ()=>list.classList.remove('drop'));
      col.addEventListener('drop', async ()=>{
        list.classList.remove('drop');
        const drag = document.querySelector('.ticket.dragging');
        if (!drag) return;
        const t = state.tickets.find(x=>x.id===drag.dataset.id);
        if (t) { t.status = col.dataset.status; await saveTickets(); }
      });
    });

    function escapeHtml(str=''){
      return str.replace(/[&<>'"]/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;',"'":'&#39;','"':'&quot;'}[m]));
    }

    loadTickets();
  </script>
</body>
</html>