<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#1a1a2e">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>üíú Bud Love Tickets</title>
  <link rel="manifest" href="/manifest.json">
  <link rel="apple-touch-icon" href="/icons/icon-192.svg">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-primary: #0a1520;
      --bg-secondary: #12202d;
      --bg-card: linear-gradient(135deg, #152535 0%, #1a3045 100%);
      --accent: #00b4d8;
      --accent-light: #48cae4;
      --text-primary: #e0e8f0;
      --text-secondary: #8899aa;
      --text-muted: #556677;
      --border: rgba(255,255,255,0.1);
      --border-hover: rgba(0,180,216,0.5);
      --success: #06d6a0;
      --warning: #ffd166;
      --info: #2196f3;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: 'Inter', -apple-system, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      overflow-x: hidden;
    }
    
    /* Header */
    .header {
      background: linear-gradient(180deg, var(--bg-secondary) 0%, var(--bg-primary) 100%);
      padding: 16px 16px 12px;
      border-bottom: 2px solid var(--accent);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .header-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 14px;
    }
    
    .logo {
      font-size: 1.1em;
      font-weight: 600;
      color: #f5e6d0;
      white-space: nowrap;
    }
    
    /* Search */
    .search-container {
      flex: 1;
      max-width: 280px;
    }
    
    .search-input {
      width: 100%;
      padding: 8px 14px;
      border-radius: 20px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.05);
      color: var(--text-primary);
      font-size: 0.85em;
      outline: none;
      transition: all 0.3s;
    }
    
    .search-input:focus {
      border-color: var(--accent);
      background: rgba(255,255,255,0.08);
    }
    
    .search-input::placeholder { color: var(--text-muted); }
    
    /* Tabs */
    .tabs {
      display: flex;
      gap: 8px;
      overflow-x: auto;
      padding: 4px 0;
      scrollbar-width: none;
    }
    
    .tabs::-webkit-scrollbar { display: none; }
    
    .tab {
      background: rgba(255,255,255,0.05);
      border: 1px solid var(--border);
      color: var(--text-secondary);
      padding: 8px 14px;
      border-radius: 8px;
      font-size: 0.8em;
      font-weight: 500;
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }
    
    .tab:hover {
      background: rgba(255,255,255,0.1);
      color: #ccc;
      transform: translateY(-1px);
    }
    
    .tab.active {
      background: var(--accent);
      border-color: var(--accent);
      color: #fff;
      box-shadow: 0 4px 12px rgba(170,51,51,0.4);
    }
    
    .tab .badge {
      background: rgba(255,255,255,0.2);
      padding: 1px 6px;
      border-radius: 10px;
      font-size: 0.75em;
      margin-left: 6px;
    }
    
    /* Content */
    .content {
      padding: 20px 16px;
      max-width: 800px;
      margin: 0 auto;
      animation: fadeIn 0.4s ease-out;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes slideIn {
      from { opacity: 0; transform: translateX(-20px); }
      to { opacity: 1; transform: translateX(0); }
    }
    
    @keyframes scaleIn {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }
    
    /* Stats Dashboard */
    .stats-dashboard {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
      margin-bottom: 24px;
      animation: slideIn 0.5s ease-out;
    }
    
    .stat-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      text-align: center;
      transition: all 0.3s;
    }
    
    .stat-card:hover {
      transform: translateY(-3px);
      border-color: var(--border-hover);
    }
    
    .stat-value {
      font-size: 2em;
      font-weight: 700;
      color: var(--accent-light);
    }
    
    .stat-label {
      font-size: 0.75em;
      color: var(--text-secondary);
      margin-top: 4px;
    }
    
    /* Project Header */
    .project-header {
      text-align: center;
      margin-bottom: 24px;
      animation: scaleIn 0.4s ease-out;
    }
    
    .project-title {
      font-size: 1.4em;
      font-weight: 600;
      color: #fff;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    
    .project-desc {
      color: var(--text-secondary);
      font-size: 0.9em;
    }
    
    .version-badge {
      background: rgba(170,51,51,0.2);
      color: var(--accent-light);
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 0.65em;
      font-weight: 500;
    }
    
    .project-meta {
      display: flex;
      gap: 12px;
      align-items: center;
      justify-content: center;
      margin-top: 8px;
      font-size: 0.8em;
      color: var(--text-muted);
    }
    
    /* Progress Bar */
    .progress-container {
      margin: 16px 0;
      padding: 12px 16px;
      background: rgba(255,255,255,0.03);
      border-radius: 12px;
    }
    
    .progress-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 0.8em;
    }
    
    .progress-label { color: var(--text-secondary); }
    .progress-value { color: var(--accent-light); font-weight: 600; }
    
    .progress-bar {
      height: 8px;
      background: rgba(255,255,255,0.1);
      border-radius: 4px;
      overflow: hidden;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent) 0%, var(--accent-light) 100%);
      border-radius: 4px;
      transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    /* Tree */
    .tree {
      position: relative;
      padding-left: 0;
    }
    
    .tree::before {
      content: '';
      position: absolute;
      left: 50%;
      top: 0;
      bottom: 0;
      width: 2px;
      background: linear-gradient(180deg, var(--accent) 0%, rgba(170,51,51,0.2) 100%);
      transform: translateX(-50%);
    }
    
    /* Feature Card */
    .feature-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 14px 18px;
      margin-bottom: 14px;
      position: relative;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
      animation: slideIn 0.4s ease-out backwards;
    }
    
    .feature-card:nth-child(1) { animation-delay: 0.05s; }
    .feature-card:nth-child(2) { animation-delay: 0.1s; }
    .feature-card:nth-child(3) { animation-delay: 0.15s; }
    .feature-card:nth-child(4) { animation-delay: 0.2s; }
    .feature-card:nth-child(5) { animation-delay: 0.25s; }
    
    .feature-card:hover {
      border-color: var(--border-hover);
      transform: translateY(-3px) scale(1.01);
      box-shadow: 0 8px 24px rgba(0,0,0,0.3);
    }
    
    .feature-card.highlight {
      border-color: gold;
      box-shadow: 0 0 20px rgba(255,215,0,0.3);
    }
    
    .feature-card.dimmed {
      opacity: 0.3;
    }
    
    .feature-card::before {
      content: '';
      position: absolute;
      left: 50%;
      top: -9px;
      width: 12px;
      height: 12px;
      background: var(--accent);
      border-radius: 50%;
      transform: translateX(-50%);
      border: 2px solid var(--bg-primary);
      transition: all 0.3s;
    }
    
    .feature-card:hover::before {
      transform: translateX(-50%) scale(1.3);
    }
    
    .feature-title {
      font-size: 0.95em;
      font-weight: 600;
      color: #fff;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .feature-icon { font-size: 1.1em; }
    
    .feature-desc {
      color: var(--text-secondary);
      font-size: 0.8em;
      line-height: 1.5;
    }
    
    .feature-tags {
      display: flex;
      gap: 6px;
      margin-top: 8px;
      flex-wrap: wrap;
    }
    
    .tag {
      background: rgba(170,51,51,0.2);
      color: var(--accent-light);
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 0.65em;
      font-weight: 500;
      transition: all 0.2s;
    }
    
    .tag.highlight {
      background: rgba(255,215,0,0.3);
      color: gold;
    }
    
    .feature-date {
      font-size: 0.65em;
      color: var(--text-muted);
      margin-top: 6px;
    }
    
    .feature-note-indicator {
      position: absolute;
      top: 8px;
      right: 8px;
      font-size: 0.8em;
    }
    
    /* All Projects Grid */
    .all-projects {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 16px;
      padding: 20px 16px;
      max-width: 1000px;
      margin: 0 auto;
    }
    
    .project-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 18px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      animation: scaleIn 0.4s ease-out backwards;
    }
    
    .project-card:nth-child(1) { animation-delay: 0.1s; }
    .project-card:nth-child(2) { animation-delay: 0.2s; }
    .project-card:nth-child(3) { animation-delay: 0.3s; }
    
    .project-card:hover {
      border-color: var(--accent);
      transform: translateY(-6px);
      box-shadow: 0 12px 36px rgba(0,0,0,0.4);
    }
    
    .project-card.highlight {
      border-color: gold;
      box-shadow: 0 0 30px rgba(255,215,0,0.3);
    }
    
    .project-card.dimmed {
      opacity: 0.3;
    }
    
    .project-card-title {
      font-size: 1.05em;
      font-weight: 600;
      color: #fff;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .project-card-desc {
      color: var(--text-secondary);
      font-size: 0.8em;
      margin-bottom: 12px;
      line-height: 1.4;
    }
    
    .project-card-stats {
      display: flex;
      gap: 12px;
      font-size: 0.7em;
      color: var(--text-muted);
      flex-wrap: wrap;
    }
    
    .stat {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    /* Cross-links indicator */
    .cross-links {
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px dashed rgba(255,255,255,0.1);
      font-size: 0.7em;
      color: var(--info);
    }
    
    .cross-link-tag {
      display: inline-block;
      background: rgba(33,150,243,0.2);
      padding: 2px 6px;
      border-radius: 4px;
      margin: 2px;
    }
    
    /* Timeline View */
    .timeline {
      position: relative;
      padding: 20px 16px;
      max-width: 900px;
      margin: 0 auto;
    }
    
    .timeline::before {
      content: '';
      position: absolute;
      left: 20px;
      top: 0;
      bottom: 0;
      width: 2px;
      background: linear-gradient(180deg, var(--accent) 0%, rgba(170,51,51,0.2) 100%);
    }
    
    @media (min-width: 600px) {
      .timeline::before { left: 50%; transform: translateX(-50%); }
    }
    
    .timeline-date {
      font-size: 0.85em;
      font-weight: 600;
      color: var(--accent-light);
      margin: 24px 0 12px 40px;
      position: relative;
    }
    
    @media (min-width: 600px) {
      .timeline-date { text-align: center; margin-left: 0; }
    }
    
    .timeline-item {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px 16px;
      margin: 12px 0 12px 40px;
      position: relative;
      transition: all 0.3s;
      animation: slideIn 0.4s ease-out;
    }
    
    .timeline-item::before {
      content: '';
      position: absolute;
      left: -28px;
      top: 14px;
      width: 10px;
      height: 10px;
      background: var(--accent);
      border-radius: 50%;
      border: 2px solid var(--bg-primary);
    }
    
    @media (min-width: 600px) {
      .timeline-item {
        width: 45%;
        margin-left: 0;
      }
      .timeline-item:nth-child(even) { margin-left: 55%; }
      .timeline-item::before {
        left: auto;
        right: -33px;
      }
      .timeline-item:nth-child(even)::before {
        left: -33px;
        right: auto;
      }
    }
    
    .timeline-item:hover {
      border-color: var(--border-hover);
      transform: translateX(5px);
    }
    
    .timeline-project {
      font-size: 0.7em;
      color: var(--accent-light);
      margin-bottom: 4px;
    }
    
    .timeline-title {
      font-weight: 600;
      margin-bottom: 4px;
    }
    
    .timeline-desc {
      font-size: 0.8em;
      color: var(--text-secondary);
    }
    
    /* Kanban / Tickets View */
    .kanban {
      display: flex;
      gap: 16px;
      padding: 16px;
      overflow-x: auto;
      min-height: 70vh;
    }
    
    @media (max-width: 600px) {
      .kanban { flex-direction: column; }
    }
    
    .kanban-column {
      flex: 1;
      min-width: 280px;
      background: var(--bg-card);
      border-radius: 12px;
      padding: 12px;
      border: 1px solid var(--border);
    }
    
    .kanban-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 4px 16px;
      border-bottom: 2px solid var(--border);
      margin-bottom: 12px;
    }
    
    .kanban-header h3 {
      margin: 0;
      font-size: 1em;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .kanban-count {
      background: var(--bg);
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 0.8em;
    }
    
    .kanban-cards {
      display: flex;
      flex-direction: column;
      gap: 10px;
      min-height: 100px;
    }
    
    .kanban-card {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px;
      cursor: grab;
      transition: all 0.2s;
      animation: slideIn 0.3s ease-out;
    }
    
    .kanban-card:hover {
      border-color: var(--accent);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(170,51,51,0.2);
    }
    
    .kanban-card.dragging {
      opacity: 0.5;
      transform: rotate(3deg);
    }
    
    .kanban-card-title {
      font-weight: 600;
      margin-bottom: 6px;
    }
    
    .kanban-card-desc {
      font-size: 0.85em;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }
    
    .kanban-card-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.75em;
      color: var(--text-muted);
    }
    
    .kanban-card-actions {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .delete-btn {
      background: none;
      border: none;
      cursor: pointer;
      opacity: 0;
      transition: opacity 0.2s;
      font-size: 0.9em;
      padding: 2px;
    }
    
    .kanban-card:hover .delete-btn {
      opacity: 0.6;
    }
    
    .delete-btn:hover {
      opacity: 1 !important;
    }
    
    .kanban-card-move {
      display: flex;
      gap: 4px;
    }
    
    .move-btn {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text-secondary);
      cursor: pointer;
      padding: 2px 8px;
      font-size: 0.8em;
      transition: all 0.2s;
    }
    
    .move-btn:hover {
      background: var(--accent);
      border-color: var(--accent);
      color: white;
    }
    
    .kanban-card-priority {
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 0.7em;
      text-transform: uppercase;
    }
    
    .priority-high { background: #ef476f; color: white; }
    .priority-medium { background: #ffd166; color: #222; }
    .priority-low { background: #06d6a0; color: #222; }
    
    .kanban-add {
      width: 100%;
      padding: 10px;
      margin-top: 12px;
      background: transparent;
      border: 2px dashed var(--border);
      border-radius: 8px;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .kanban-add:hover {
      border-color: var(--accent);
      color: var(--accent);
    }
    
    .share-bud-btn {
      width: 100%;
      padding: 10px;
      margin-top: 8px;
      background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);
      border: none;
      border-radius: 8px;
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .share-bud-btn:hover {
      transform: scale(1.02);
      box-shadow: 0 4px 12px rgba(155,89,182,0.4);
    }
    
    .drop-zone {
      border: 2px dashed var(--accent);
      background: rgba(170,51,51,0.1);
    }
    
    /* Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.8);
      backdrop-filter: blur(4px);
      z-index: 200;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
      animation: fadeIn 0.2s ease-out;
    }
    
    .modal-overlay.active { display: flex; }
    
    .modal {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 16px;
      max-width: 500px;
      width: 100%;
      max-height: 80vh;
      overflow-y: auto;
      animation: scaleIn 0.3s ease-out;
    }
    
    .modal-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .modal-title {
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .modal-close {
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 1.5em;
      cursor: pointer;
      padding: 4px;
      line-height: 1;
    }
    
    .modal-close:hover { color: var(--text-primary); }
    
    .modal-body { padding: 20px; }
    
    /* Ticket Form */
    .ticket-modal { max-width: 400px; }
    
    .form-group {
      margin-bottom: 16px;
    }
    
    .form-group label {
      display: block;
      font-size: 0.85em;
      font-weight: 600;
      margin-bottom: 6px;
      color: var(--text-secondary);
    }
    
    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 10px 12px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 0.95em;
      font-family: inherit;
    }
    
    .form-group input:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--accent);
    }
    
    .priority-toggle {
      display: flex;
      gap: 8px;
    }
    
    .priority-btn {
      flex: 1;
      padding: 8px 12px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.85em;
    }
    
    .priority-btn:hover {
      border-color: var(--accent);
    }
    
    .priority-btn.active[data-priority="low"] {
      background: #06d6a0;
      border-color: #06d6a0;
      color: #222;
    }
    
    .priority-btn.active[data-priority="medium"] {
      background: #ffd166;
      border-color: #ffd166;
      color: #222;
    }
    
    .priority-btn.active[data-priority="high"] {
      background: #ef476f;
      border-color: #ef476f;
      color: white;
    }
    
    .submit-btn {
      width: 100%;
      padding: 12px;
      background: var(--accent);
      border: none;
      border-radius: 8px;
      color: white;
      font-size: 1em;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .submit-btn:hover {
      background: var(--accent-light);
    }
    
    .modal-section {
      margin-bottom: 16px;
    }
    
    .modal-section-title {
      font-size: 0.75em;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--text-muted);
      margin-bottom: 8px;
    }
    
    .modal-desc {
      color: var(--text-secondary);
      font-size: 0.9em;
      line-height: 1.6;
    }
    
    /* Notes Section */
    .notes-section {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--border);
    }
    
    .notes-list {
      margin-bottom: 12px;
    }
    
    .note-item {
      background: rgba(255,255,255,0.03);
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 8px;
      font-size: 0.85em;
    }
    
    .note-text { margin-bottom: 4px; }
    
    .note-date {
      font-size: 0.75em;
      color: var(--text-muted);
    }
    
    .note-input {
      width: 100%;
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.05);
      color: var(--text-primary);
      font-size: 0.85em;
      resize: none;
      outline: none;
      min-height: 60px;
    }
    
    .note-input:focus {
      border-color: var(--accent);
    }
    
    .note-submit {
      margin-top: 8px;
      padding: 8px 16px;
      border-radius: 8px;
      border: none;
      background: var(--accent);
      color: #fff;
      font-size: 0.85em;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .note-submit:hover {
      background: var(--accent-light);
    }
    
    /* Toast */
    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      padding: 12px 20px;
      border-radius: 12px;
      font-size: 0.85em;
      z-index: 300;
      transition: transform 0.3s ease-out;
      box-shadow: 0 8px 24px rgba(0,0,0,0.4);
    }
    
    .toast.show {
      transform: translateX(-50%) translateY(0);
    }
    
    /* Hidden */
    .hidden { display: none !important; }
    
    /* Footer */
    .footer {
      text-align: center;
      padding: 24px 20px;
      color: var(--text-muted);
      font-size: 0.7em;
    }
    
    /* Keyboard navigation */
    .feature-card:focus,
    .project-card:focus,
    .tab:focus {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }
    
    /* Offline indicator */
    .offline-banner {
      background: var(--warning);
      color: #000;
      text-align: center;
      padding: 8px;
      font-size: 0.8em;
      font-weight: 500;
      display: none;
    }
    
    .offline-banner.show { display: block; }
    
    /* Loading */
    .loading {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-secondary);
    }
    
    .loading-spinner {
      display: inline-block;
      width: 40px;
      height: 40px;
      border: 3px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="offline-banner" id="offlineBanner">üì¥ You're offline - viewing cached data</div>
  
  <div class="header">
    <div class="header-top">
      <div class="logo">üíú Bud Love Tickets</div>
      <div class="search-container">
        <input type="text" class="search-input" id="searchInput" placeholder="Search..." autocomplete="off">
      </div>
    </div>
    <div class="tabs" id="tabs">
      <button class="tab active" data-project="all" tabindex="0">üìä All Cases</button>
      <button class="tab" data-project="timeline" tabindex="0">üìÖ Timeline</button>
      <button class="tab" data-project="tickets" tabindex="0">üé´ Tickets</button>
    </div>
  </div>
  
  <div id="loadingView" class="loading">
    <div class="loading-spinner"></div>
    <p style="margin-top: 16px">Loading evidence...</p>
  </div>
  
  <div id="allView" class="hidden">
    <div class="content">
      <div class="stats-dashboard" id="statsDashboard"></div>
    </div>
    <div class="all-projects" id="projectsGrid"></div>
  </div>
  
  <div id="projectView" class="content hidden"></div>
  
  <div id="timelineView" class="timeline hidden"></div>
  
  <div id="ticketsView" class="kanban hidden">
    <div class="kanban-column" data-status="todo">
      <div class="kanban-header">
        <h3>üìã To Do</h3>
        <span class="kanban-count" id="todoCount">0</span>
      </div>
      <div class="kanban-cards" id="todoCards"></div>
      <button class="kanban-add" onclick="addTicket('todo')">+ Add ticket</button>
    </div>
    <div class="kanban-column" data-status="doing">
      <div class="kanban-header">
        <h3>üî® Doing</h3>
        <span class="kanban-count" id="doingCount">0</span>
      </div>
      <div class="kanban-cards" id="doingCards"></div>
      <button class="kanban-add" onclick="addTicket('doing')">+ Add ticket</button>
      <button class="share-bud-btn" onclick="shareWithBud()">üíú Share with Bud</button>
    </div>
    <div class="kanban-column" data-status="done">
      <div class="kanban-header">
        <h3>‚úÖ Done</h3>
        <span class="kanban-count" id="doneCount">0</span>
      </div>
      <div class="kanban-cards" id="doneCards"></div>
      <button class="kanban-add" onclick="addTicket('done')">+ Add ticket</button>
    </div>
  </div>
  
  <!-- Ticket Modal -->
  <div class="modal-overlay" id="ticketModalOverlay">
    <div class="modal ticket-modal">
      <div class="modal-header">
        <div class="modal-title">üé´ New Ticket</div>
        <button class="modal-close" onclick="closeTicketModal()">&times;</button>
      </div>
      <div class="modal-body">
        <form id="ticketForm" onsubmit="submitTicket(event)">
          <input type="hidden" id="ticketStatus" value="todo">
          
          <div class="form-group">
            <label for="ticketTitle">Title</label>
            <input type="text" id="ticketTitle" placeholder="What needs to be done?" required>
          </div>
          
          <div class="form-group">
            <label for="ticketDesc">Description</label>
            <textarea id="ticketDesc" placeholder="Optional details..." rows="3"></textarea>
          </div>
          
          <div class="form-group">
            <label>Priority</label>
            <div class="priority-toggle">
              <button type="button" class="priority-btn" data-priority="low">Low</button>
              <button type="button" class="priority-btn active" data-priority="medium">Medium</button>
              <button type="button" class="priority-btn" data-priority="high">High</button>
            </div>
          </div>
          
          <button type="submit" class="submit-btn">Create Ticket</button>
        </form>
      </div>
    </div>
  </div>
  
  <div class="modal-overlay" id="modalOverlay">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title" id="modalTitle"></div>
        <button class="modal-close" id="modalClose">&times;</button>
      </div>
      <div class="modal-body" id="modalBody"></div>
    </div>
  </div>
  
  <div class="toast" id="toast"></div>
  
  <div class="footer">Built together ‚Ä¢ PWA enabled ‚Ä¢ Real-time sync</div>

  <script>
    // ===== STATE =====
    let state = {
      projects: {},
      allFeatures: [],
      stats: {},
      crossLinks: [],
      achievements: [],
      currentView: 'all',
      currentProject: null,
      searchQuery: '',
      focusIndex: -1
    };
    
    // ===== PWA =====
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js')
        .then(reg => console.log('‚úÖ Service Worker registered'))
        .catch(err => console.log('‚ùå SW registration failed:', err));
    }
    
    window.addEventListener('online', () => {
      document.getElementById('offlineBanner').classList.remove('show');
      loadData();
    });
    
    window.addEventListener('offline', () => {
      document.getElementById('offlineBanner').classList.add('show');
    });
    
    // ===== URL STATE =====
    function updateURL() {
      const params = new URLSearchParams();
      if (state.currentView !== 'all') params.set('view', state.currentView);
      if (state.currentProject) params.set('project', state.currentProject);
      if (state.searchQuery) params.set('q', state.searchQuery);
      
      const newURL = params.toString() ? `?${params.toString()}` : window.location.pathname;
      history.replaceState(null, '', newURL);
    }
    
    function loadURLState() {
      const params = new URLSearchParams(window.location.search);
      if (params.get('q')) {
        state.searchQuery = params.get('q');
        document.getElementById('searchInput').value = state.searchQuery;
      }
      if (params.get('view')) state.currentView = params.get('view');
      if (params.get('project')) state.currentProject = params.get('project');
    }
    
    function shareURL() {
      const url = window.location.href;
      if (navigator.share) {
        navigator.share({ title: 'Bud Love Tickets', url });
      } else if (navigator.clipboard) {
        navigator.clipboard.writeText(url);
        showToast('üîó Link copied to clipboard!');
      }
    }
    
    // ===== DATA LOADING =====
    async function loadData() {
      try {
        const res = await fetch('/api/projects');
        const data = await res.json();
        
        state.projects = data.projects || {};
        state.allFeatures = data.allFeatures || [];
        state.stats = data.stats || {};
        state.crossLinks = data.crossLinks || [];
        state.achievements = data.achievements || [];
        
        // Hide offline banner - we got fresh data
        document.getElementById('offlineBanner').classList.remove('show');
        
        // Only cache if not already offline data from SW
        if (!data.offline) {
          localStorage.setItem('bud-love-tickets-cache', JSON.stringify(data));
        }
        
        document.getElementById('loadingView').classList.add('hidden');
        initTabs();
        renderAchievements();
        loadURLState();
        navigateToView(state.currentView, state.currentProject);
      } catch (e) {
        console.error('Failed to load:', e);
        // Only show offline if actually offline
        if (!navigator.onLine) {
          document.getElementById('offlineBanner').classList.add('show');
        }
        // Try loading from cache
        const cached = localStorage.getItem('bud-love-tickets-cache');
        if (cached) {
          const data = JSON.parse(cached);
          state.projects = data.projects || {};
          state.allFeatures = data.allFeatures || [];
          state.stats = data.stats || {};
          state.crossLinks = data.crossLinks || [];
          state.achievements = data.achievements || [];
          
          document.getElementById('loadingView').classList.add('hidden');
          initTabs();
          renderAchievements();
          loadURLState();
          navigateToView(state.currentView, state.currentProject);
        }
      }
    }
    
    // ===== WEBSOCKET =====
    function connectWebSocket() {
      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      const ws = new WebSocket(`${protocol}//${window.location.host}`);
      
      ws.onmessage = (e) => {
        const data = JSON.parse(e.data);
        if (data.type === 'refresh') {
          showToast('üîÑ Evidence updated!');
          loadData();
        } else if (data.type === 'tickets') {
          tickets = data.data;
          if (state.currentView === 'tickets') {
            renderTickets();
          }
        }
      };
      
      ws.onclose = () => {
        setTimeout(connectWebSocket, 3000);
      };
    }
    
    // ===== TABS =====
    function initTabs() {
      const tabsContainer = document.getElementById('tabs');
      
      // Click handlers (only fixed tabs now: All Cases, Timeline, Tickets)
      tabsContainer.addEventListener('click', (e) => {
        const tab = e.target.closest('.tab');
        if (tab) {
          const project = tab.dataset.project;
          if (project === 'timeline') {
            navigateToView('timeline');
          } else if (project === 'tickets') {
            navigateToView('tickets');
          } else if (project === 'all') {
            navigateToView('all');
          }
        }
      });
    }
    
    function navigateToView(view, project = null) {
      state.currentView = view;
      state.currentProject = project;
      
      // Update tabs
      document.querySelectorAll('.tab').forEach(t => {
        const isActive = (view === 'project' && t.dataset.project === project) ||
                        (view === 'all' && t.dataset.project === 'all') ||
                        (view === 'timeline' && t.dataset.project === 'timeline') ||
                        (view === 'tickets' && t.dataset.project === 'tickets');
        t.classList.toggle('active', isActive);
      });
      
      // Hide all views
      document.getElementById('allView').classList.add('hidden');
      document.getElementById('projectView').classList.add('hidden');
      document.getElementById('timelineView').classList.add('hidden');
      document.getElementById('ticketsView').classList.add('hidden');
      
      // Show appropriate view
      if (view === 'all') {
        document.getElementById('allView').classList.remove('hidden');
        renderAllProjects();
      } else if (view === 'timeline') {
        document.getElementById('timelineView').classList.remove('hidden');
        renderTimeline();
      } else if (view === 'tickets') {
        document.getElementById('ticketsView').classList.remove('hidden');
        renderTickets();
      } else if (view === 'project' && project) {
        document.getElementById('projectView').classList.remove('hidden');
        renderProject(project);
      }
      
      updateURL();
      state.focusIndex = -1;
    }
    
    // ===== ACHIEVEMENTS =====
    function renderAchievements() {
      const container = document.getElementById('achievements');
      container.innerHTML = state.achievements.slice(0, 6).map(a => 
        `<span class="achievement" title="${a.name}: ${a.desc}">${a.icon}</span>`
      ).join('');
    }
    
    // ===== STATS DASHBOARD =====
    function renderStatsDashboard() {
      return `
        <div class="stat-card">
          <div class="stat-value">${state.stats.totalProjects || 0}</div>
          <div class="stat-label">Projects</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${state.stats.totalFeatures || 0}</div>
          <div class="stat-label">Features</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${state.stats.totalUpdates || 0}</div>
          <div class="stat-label">Updates</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${(state.stats.allTags || []).length}</div>
          <div class="stat-label">Tags</div>
        </div>
      `;
    }
    
    // ===== ALL PROJECTS =====
    function renderAllProjects() {
      document.getElementById('statsDashboard').innerHTML = renderStatsDashboard();
      
      const container = document.getElementById('projectsGrid');
      const query = state.searchQuery.toLowerCase();
      
      container.innerHTML = Object.entries(state.projects).map(([key, proj]) => {
        const matchesSearch = !query || 
          proj.title.toLowerCase().includes(query) ||
          proj.desc.toLowerCase().includes(query) ||
          proj.features.some(f => 
            f.title.toLowerCase().includes(query) ||
            f.desc.toLowerCase().includes(query) ||
            f.tags.some(t => t.toLowerCase().includes(query))
          );
        
        const crossLink = state.crossLinks.find(l => l.from === key || l.to === key);
        
        return `
          <div class="project-card ${matchesSearch ? (query ? 'highlight' : '') : 'dimmed'}" 
               onclick="navigateToView('project', '${key}')" tabindex="0" data-key="${key}">
            <div class="project-card-title">${proj.icon} ${proj.title}</div>
            <div class="project-card-desc">${proj.desc || 'No description'}</div>
            <div class="project-card-stats">
              <span class="stat">üìã ${proj.features.length} features</span>
              <span class="stat">üìÖ ${proj.created}</span>
              <span class="stat">v${proj.version}</span>
            </div>
            ${crossLink ? `
              <div class="cross-links">
                üîó Connected via: ${crossLink.keywords.map(k => `<span class="cross-link-tag">${k}</span>`).join('')}
              </div>
            ` : ''}
          </div>
        `;
      }).join('');
    }
    
    // ===== PROJECT VIEW =====
    function renderProject(key) {
      const proj = state.projects[key];
      if (!proj) return;
      
      const query = state.searchQuery.toLowerCase();
      const progressPercent = Math.min(100, Math.round((proj.features.length / (proj.targetFeatures || 10)) * 100));
      
      const container = document.getElementById('projectView');
      container.innerHTML = `
        <div class="project-header">
          <div class="project-title">
            ${proj.icon} ${proj.title}
            <span class="version-badge">v${proj.version}</span>
          </div>
          <div class="project-desc">${proj.desc || ''}</div>
          <div class="project-meta">
            <span>üìÖ Created ${proj.created}</span>
            <span>üìù ${proj.history.length} updates</span>
          </div>
        </div>
        
        <div class="progress-container">
          <div class="progress-header">
            <span class="progress-label">Feature Progress</span>
            <span class="progress-value">${proj.features.length}/${proj.targetFeatures || 10} (${progressPercent}%)</span>
          </div>
          <div class="progress-bar">
            <div class="progress-fill" style="width: ${progressPercent}%"></div>
          </div>
        </div>
        
        <div class="tree">
          ${proj.features.map((f, i) => {
            const matchesSearch = !query ||
              f.title.toLowerCase().includes(query) ||
              f.desc.toLowerCase().includes(query) ||
              f.tags.some(t => t.toLowerCase().includes(query));
            
            const notes = getNotes(key, f.title);
            const highlightTags = f.tags.map(t => 
              query && t.toLowerCase().includes(query) ? 'highlight' : ''
            );
            
            return `
              <div class="feature-card ${matchesSearch ? (query ? 'highlight' : '') : 'dimmed'}" 
                   tabindex="0" data-index="${i}" data-project="${key}" data-feature="${f.title}"
                   onclick="openFeatureModal('${key}', ${i})">
                ${notes.length ? '<span class="feature-note-indicator">üí¨</span>' : ''}
                <div class="feature-title">
                  <span class="feature-icon">${f.icon}</span>
                  ${highlightMatch(f.title, query)}
                </div>
                <div class="feature-desc">${highlightMatch(f.desc, query)}</div>
                <div class="feature-tags">
                  ${f.tags.map((t, ti) => `<span class="tag ${highlightTags[ti]}">${t}</span>`).join('')}
                </div>
                <div class="feature-date">Added ${f.added}</div>
              </div>
            `;
          }).join('')}
        </div>
        
        <div class="history-section" style="margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--border);">
          <div style="font-size: 0.85em; font-weight: 600; color: var(--text-secondary); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 1px;">üìú Version History</div>
          ${proj.history.slice().reverse().map(h => `
            <div style="display: flex; gap: 12px; margin-bottom: 12px; font-size: 0.85em;">
              <span style="background: rgba(255,255,255,0.1); color: #aaa; padding: 2px 8px; border-radius: 6px; font-weight: 500; white-space: nowrap;">v${h.version}</span>
              <span style="color: var(--text-muted); white-space: nowrap;">${h.date}</span>
              <span style="color: var(--text-secondary);">${h.changes}</span>
            </div>
          `).join('')}
        </div>
      `;
    }
    
    // ===== TIMELINE VIEW =====
    function renderTimeline() {
      const container = document.getElementById('timelineView');
      const query = state.searchQuery.toLowerCase();
      
      // Group features by date
      const byDate = {};
      state.allFeatures.forEach(f => {
        const date = f.date || f.added || 'Unknown';
        if (!byDate[date]) byDate[date] = [];
        byDate[date].push(f);
      });
      
      // Sort dates descending
      const dates = Object.keys(byDate).sort().reverse();
      
      container.innerHTML = dates.map(date => {
        const features = byDate[date];
        return `
          <div class="timeline-date">${date}</div>
          ${features.map(f => {
            const matchesSearch = !query ||
              f.title.toLowerCase().includes(query) ||
              f.desc.toLowerCase().includes(query);
            
            const proj = state.projects[f.project];
            return `
              <div class="timeline-item ${matchesSearch ? '' : 'dimmed'}">
                <div class="timeline-project">${proj ? proj.icon : 'üìÅ'} ${proj ? proj.title : f.project}</div>
                <div class="timeline-title">${highlightMatch(f.title, query)}</div>
                <div class="timeline-desc">${highlightMatch(f.desc || '', query)}</div>
              </div>
            `;
          }).join('')}
        `;
      }).join('');
    }
    
    // ===== TICKETS / KANBAN =====
    let tickets = [];
    const TICKETS_KEY = 'bud-love-tickets';
    
    function saveTicketsLocal() {
      localStorage.setItem(TICKETS_KEY, JSON.stringify(tickets));
    }
    
    async function loadTickets() {
      try {
        const saved = localStorage.getItem(TICKETS_KEY);
        tickets = saved ? JSON.parse(saved) : [];
        if (state.currentView === 'tickets') renderTickets();
      } catch (e) {
        console.error('Failed to load tickets:', e);
        tickets = [];
      }
    }
    
    function renderTickets() {
      const statuses = ['todo', 'doing', 'done'];
      statuses.forEach(status => {
        const container = document.getElementById(status + 'Cards');
        const count = document.getElementById(status + 'Count');
        const filtered = tickets.filter(t => t.status === status);
        count.textContent = filtered.length;
        
        container.innerHTML = filtered.map(t => {
          const prevStatus = status === 'doing' ? 'todo' : (status === 'done' ? 'doing' : null);
          const nextStatus = status === 'todo' ? 'doing' : (status === 'doing' ? 'done' : null);
          return `
          <div class="kanban-card" draggable="true" data-id="${t.id}" 
               ondragstart="dragStart(event)" ondragend="dragEnd(event)"
               onclick="editTicket('${t.id}')">
            <div class="kanban-card-title">${t.title}</div>
            ${t.desc ? `<div class="kanban-card-desc">${t.desc}</div>` : ''}
            <div class="kanban-card-meta">
              <div class="kanban-card-move">
                ${prevStatus ? `<button class="move-btn" onclick="event.stopPropagation(); moveTicket('${t.id}', '${prevStatus}')" title="Move left">‚óÄ</button>` : ''}
                ${nextStatus ? `<button class="move-btn" onclick="event.stopPropagation(); moveTicket('${t.id}', '${nextStatus}')" title="Move right">‚ñ∂</button>` : ''}
              </div>
              <div class="kanban-card-actions">
                ${t.priority ? `<span class="kanban-card-priority priority-${t.priority}">${t.priority}</span>` : ''}
                <button class="delete-btn" onclick="event.stopPropagation(); deleteTicket('${t.id}')" title="Delete">üóëÔ∏è</button>
              </div>
            </div>
          </div>
        `}).join('');
      });
      
      // Setup drop zones
      document.querySelectorAll('.kanban-cards').forEach(zone => {
        zone.ondragover = e => { e.preventDefault(); zone.classList.add('drop-zone'); };
        zone.ondragleave = () => zone.classList.remove('drop-zone');
        zone.ondrop = e => dropTicket(e, zone);
      });
      
      // Setup mobile touch drag
      initTouchDrag();
    }
    
    let draggedId = null;
    let touchStartY = 0;
    let touchedCard = null;
    
    function dragStart(e) {
      draggedId = e.target.dataset.id;
      e.target.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
    }
    
    function dragEnd(e) {
      e.target.classList.remove('dragging');
    }
    
    async function dropTicket(e, zone) {
      e.preventDefault();
      zone.classList.remove('drop-zone');
      const newStatus = zone.closest('.kanban-column').dataset.status;
      
      if (draggedId) {
        const ticket = tickets.find(t => t.id === draggedId);
        if (ticket) {
          ticket.status = newStatus;
          saveTicketsLocal();
          renderTickets();
        }
        draggedId = null;
      }
    }
    
    // Mobile touch drag support - simpler approach with status buttons
    function initTouchDrag() {
      // Touch drag is complex on mobile - using move buttons instead
    }
    
    function addTicket(status) {
      document.getElementById('ticketStatus').value = status;
      document.getElementById('ticketTitle').value = '';
      document.getElementById('ticketDesc').value = '';
      document.querySelectorAll('.priority-btn').forEach(b => b.classList.remove('active'));
      document.querySelector('.priority-btn[data-priority="medium"]').classList.add('active');
      document.getElementById('ticketForm').dataset.editId = '';
      document.querySelector('.modal-title').textContent = 'üé´ New Ticket';
      document.querySelector('.submit-btn').textContent = 'Create Ticket';
      document.getElementById('ticketModalOverlay').style.display = 'flex';
      document.getElementById('ticketTitle').focus();
    }
    
    function closeTicketModal() {
      document.getElementById('ticketModalOverlay').style.display = 'none';
      document.getElementById('ticketForm').dataset.editId = '';
    }
    
    async function submitTicket(e) {
      e.preventDefault();
      const form = document.getElementById('ticketForm');
      const editId = form.dataset.editId;
      const title = document.getElementById('ticketTitle').value;
      const desc = document.getElementById('ticketDesc').value;
      const status = document.getElementById('ticketStatus').value;
      const priority = document.querySelector('.priority-btn.active').dataset.priority;
      
      if (editId) {
        // Update existing
        const ticket = tickets.find(t => t.id === editId);
        if (ticket) {
          ticket.title = title;
          ticket.desc = desc;
          ticket.status = status;
          ticket.priority = priority;
        }
      } else {
        // Create new
        tickets.push({
          id: Date.now().toString(),
          title,
          desc,
          status,
          priority,
          created: new Date().toISOString().split('T')[0]
        });
      }
      
      saveTicketsLocal();
      renderTickets();
      closeTicketModal();
    }
    
    // Priority toggle handlers
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('.priority-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.priority-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
        });
      });
      
      // Close modal on overlay click
      document.getElementById('ticketModalOverlay').addEventListener('click', (e) => {
        if (e.target.id === 'ticketModalOverlay') closeTicketModal();
      });
    });
    
    async function deleteTicket(id) {
      if (confirm('Delete this ticket?')) {
        tickets = tickets.filter(t => t.id !== id);
        saveTicketsLocal();
        renderTickets();
      }
    }
    
    async function moveTicket(id, newStatus) {
      const ticket = tickets.find(t => t.id === id);
      if (ticket) {
        ticket.status = newStatus;
        saveTicketsLocal();
        renderTickets();
      }
    }
    
    function shareWithBud() {
      const doingTickets = tickets.filter(t => t.status === 'doing');
      if (doingTickets.length === 0) {
        showToast('üìã No tickets in Doing!');
        return;
      }
      
      const message = 'üé´ do the tickets:\n' + doingTickets.map(t => 
        `‚Ä¢ ${t.title}${t.desc ? ' - ' + t.desc : ''}`
      ).join('\n');
      
      navigator.clipboard.writeText(message).then(() => {
        showToast('üíú Copied! Paste in Discord to send to Bud');
      }).catch(() => {
        // Fallback
        const ta = document.createElement('textarea');
        ta.value = message;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
        showToast('üíú Copied! Paste in Discord to send to Bud');
      });
    }
    
    function editTicket(id) {
      const ticket = tickets.find(t => t.id === id);
      if (!ticket) return;
      
      document.getElementById('ticketStatus').value = ticket.status;
      document.getElementById('ticketTitle').value = ticket.title;
      document.getElementById('ticketDesc').value = ticket.desc || '';
      document.querySelectorAll('.priority-btn').forEach(b => {
        b.classList.toggle('active', b.dataset.priority === ticket.priority);
      });
      
      // Store editing ID
      document.getElementById('ticketForm').dataset.editId = id;
      document.querySelector('.modal-title').textContent = '‚úèÔ∏è Edit Ticket';
      document.querySelector('.submit-btn').textContent = 'Save Changes';
      document.getElementById('ticketModalOverlay').style.display = 'flex';
      document.getElementById('ticketTitle').focus();
    }
    
    async function letsDoIt() {
      console.log('letsDoIt called, tickets:', tickets);
      const todoTickets = tickets.filter(t => t.status === 'todo');
      console.log('Todo tickets:', todoTickets.length);
      
      if (todoTickets.length === 0) {
        showToast('üìã No tasks in To Do!');
        return;
      }
      
      // Move all to doing
      for (const t of todoTickets) {
        await fetch(`/api/tickets/${t.id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status: 'doing' })
        });
      }
      
      showToast('üöÄ Moved ' + todoTickets.length + ' task(s) to Doing!');
    }
    
    // Load tickets on startup
    loadTickets();

    // ===== SEARCH =====
    function highlightMatch(text, query) {
      if (!query || !text) return text;
      const regex = new RegExp(`(${query})`, 'gi');
      return text.replace(regex, '<mark style="background: rgba(255,215,0,0.4); color: inherit; padding: 0 2px; border-radius: 2px;">$1</mark>');
    }
    
    document.getElementById('searchInput').addEventListener('input', (e) => {
      state.searchQuery = e.target.value;
      updateURL();
      
      // Re-render current view
      if (state.currentView === 'all') {
        renderAllProjects();
      } else if (state.currentView === 'timeline') {
        renderTimeline();
      } else if (state.currentView === 'tickets') {
        renderTickets();
      } else if (state.currentView === 'project') {
        renderProject(state.currentProject);
      }
    });
    
    // ===== NOTES/COMMENTS =====
    function getNotes(project, feature) {
      const key = `detective-notes-${project}-${feature}`;
      try {
        return JSON.parse(localStorage.getItem(key) || '[]');
      } catch {
        return [];
      }
    }
    
    function saveNote(project, feature, text) {
      const key = `detective-notes-${project}-${feature}`;
      const notes = getNotes(project, feature);
      notes.push({
        text,
        date: new Date().toISOString()
      });
      localStorage.setItem(key, JSON.stringify(notes));
      return notes;
    }
    
    // ===== MODAL =====
    function openFeatureModal(projectKey, featureIndex) {
      const proj = state.projects[projectKey];
      if (!proj) return;
      
      const feature = proj.features[featureIndex];
      if (!feature) return;
      
      const notes = getNotes(projectKey, feature.title);
      
      document.getElementById('modalTitle').innerHTML = `${feature.icon} ${feature.title}`;
      document.getElementById('modalBody').innerHTML = `
        <div class="modal-section">
          <div class="modal-section-title">Description</div>
          <div class="modal-desc">${feature.desc}</div>
        </div>
        <div class="modal-section">
          <div class="modal-section-title">Tags</div>
          <div class="feature-tags">
            ${feature.tags.map(t => `<span class="tag">${t}</span>`).join('')}
          </div>
        </div>
        <div class="modal-section">
          <div class="modal-section-title">Added</div>
          <div class="modal-desc">${feature.added}</div>
        </div>
        <div class="notes-section">
          <div class="modal-section-title">üí¨ Notes</div>
          <div class="notes-list">
            ${notes.map(n => `
              <div class="note-item">
                <div class="note-text">${n.text}</div>
                <div class="note-date">${new Date(n.date).toLocaleString()}</div>
              </div>
            `).join('') || '<div style="color: var(--text-muted); font-size: 0.85em;">No notes yet</div>'}
          </div>
          <textarea class="note-input" id="noteInput" placeholder="Add a note..."></textarea>
          <button class="note-submit" onclick="submitNote('${projectKey}', '${feature.title}')">Add Note</button>
        </div>
      `;
      
      document.getElementById('modalOverlay').classList.add('active');
    }
    
    function submitNote(projectKey, featureTitle) {
      const input = document.getElementById('noteInput');
      const text = input.value.trim();
      if (!text) return;
      
      saveNote(projectKey, featureTitle, text);
      input.value = '';
      showToast('üí¨ Note added!');
      
      // Re-render to show indicator
      if (state.currentView === 'project') {
        renderProject(state.currentProject);
      }
      
      // Refresh modal
      const proj = state.projects[projectKey];
      const featureIndex = proj.features.findIndex(f => f.title === featureTitle);
      openFeatureModal(projectKey, featureIndex);
    }
    
    function closeModal() {
      document.getElementById('modalOverlay').classList.remove('active');
    }
    
    document.getElementById('modalClose').addEventListener('click', closeModal);
    document.getElementById('modalOverlay').addEventListener('click', (e) => {
      if (e.target === e.currentTarget) closeModal();
    });
    
    // ===== KEYBOARD NAVIGATION =====
    document.addEventListener('keydown', (e) => {
      // `/` to focus search
      if (e.key === '/' && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') {
        e.preventDefault();
        document.getElementById('searchInput').focus();
        return;
      }
      
      // Escape to close modal or blur search
      if (e.key === 'Escape') {
        if (document.getElementById('modalOverlay').classList.contains('active')) {
          closeModal();
        } else {
          document.getElementById('searchInput').blur();
          state.searchQuery = '';
          document.getElementById('searchInput').value = '';
          updateURL();
          if (state.currentView === 'all') renderAllProjects();
          else if (state.currentView === 'project') renderProject(state.currentProject);
          else if (state.currentView === 'timeline') renderTimeline();
        }
        return;
      }
      
      // Arrow navigation
      if (e.key === 'ArrowDown' || e.key === 'ArrowUp') {
        e.preventDefault();
        const cards = document.querySelectorAll('.feature-card:not(.dimmed), .project-card:not(.dimmed)');
        if (cards.length === 0) return;
        
        if (e.key === 'ArrowDown') {
          state.focusIndex = Math.min(state.focusIndex + 1, cards.length - 1);
        } else {
          state.focusIndex = Math.max(state.focusIndex - 1, 0);
        }
        
        cards[state.focusIndex]?.focus();
      }
      
      // Enter to open/select
      if (e.key === 'Enter' && document.activeElement.classList.contains('feature-card')) {
        const project = document.activeElement.dataset.project;
        const index = parseInt(document.activeElement.dataset.index);
        openFeatureModal(project, index);
      }
      
      if (e.key === 'Enter' && document.activeElement.classList.contains('project-card')) {
        const key = document.activeElement.dataset.key;
        navigateToView('project', key);
      }
    });
    
    // ===== TOAST =====
    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 3000);
    }
    
    // ===== INIT =====
    loadData();
    connectWebSocket();
  </script>
</body>
</html>
